name: On release
on:
  release:
    types: [created]
jobs:
  deploy-docs:
    runs-on: ubuntu-latest
    steps:
      # Setup
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Update submodules
        run: git submodule update --remote --recursive
      - uses: actions/setup-node@v3
        id: setup_node_id
        with:
          node-version: 18
      - uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2

      # Update document
      - name: Update document
        run: |
          wget https://github.com/phpDocumentor/phpDocumentor/releases/download/v3.3.1/phpDocumentor.phar
          php phpDocumentor.phar run -d src -t docs
      - run: |
          diff=$(git --no-pager diff --name-only HEAD)
          echo "DIFF_IS_EMPTY=$([[ -z "$diff" ]] && echo 'true' || echo 'false')" >> $GITHUB_ENV

      - if: ${{ env.DIFF_IS_EMPTY != 'true' }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/**
          git commit --allow-empty -m "Update document for release (${{ github.event.release.tag_name }})"
          git push origin master
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
